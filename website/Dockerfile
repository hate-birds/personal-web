# Используем официальную Node.js среду выполнения в качестве базового образа
FROM node:21-alpine 

#Настроиваем пользователя на запуск приложения
#Это сделано для того, чтобы избежать запуска приложения от имени root
#Если приложение запущено от имени root, любая уязвимость в приложении может быть использована для получения доступа к хост-системе
RUN addgroup app && adduser -S -G app app

#Переход на уникального пользователя
USER app

# Устанавливаем рабочий каталог в /app
WORKDIR /app

# Копируем package.json и package-lock.json в рабочий каталог
COPY package*.json ./

# Иногда владелец файлов в рабочем каталоге меняется на root
# И, таким образом, приложение не может получить доступ к файлам и выдает ошибку -> EACCES: отказано в разрешении
# Чтобы избежать этого, измените права собственности на файлы на пользователя root
USER root

#Команда chown изменяет владельца пользователя и/или группы для данного файла.
RUN chown -R app:app .

#Переход на уникального пользователя
USER app

#Установливаем зависимости
RUN npm install

# Скопируйте содержимое текущего каталога в контейнер по адресу /app
COPY . .

# Открываем порт 3000 для внешнего мира
EXPOSE 3000

# Выполняем npm run start при запуске контейнера
CMD npm run start